<form th:action="@{/web/materiales/guardar}" th:object="${material}" method="post">

    <div class="modal-body">

        <input type="hidden" th:field="*{id}">
        <input type="hidden" th:field="*{stock}">

        <!-- Persistencia de Filtros -->
        <input type="hidden" name="filtroCategoriaId" th:value="${filtroCategoriaId}">
        <input type="hidden" name="filtroMostrarTodos" th:value="${filtroMostrarTodos}">

        <div class="alert alert-info py-2 mb-3 small">
            <i class="fa-solid fa-info-circle"></i> Defina si es Materia Prima (lo que compra) o Producto (lo que
            vende).
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold d-block">Tipo de Registro</label>

            <input type="hidden" th:if="${material.id != null}" th:name="tipo" th:value="*{tipo}">

            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" th:field="*{tipo}" id="tipoResiduo" value="RESIDUO" checked
                    onclick="cambiarFormulario()" th:disabled="${material.id != null}">
                <label class="form-check-label" for="tipoResiduo">Materia Prima (Residuo)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" th:field="*{tipo}" id="tipoProducto" value="PRODUCTO"
                    onclick="cambiarFormulario()" th:disabled="${material.id != null}">
                <label class="form-check-label" for="tipoProducto">Producto Terminado</label>
            </div>

            <div th:if="${material.id != null}" class="form-text text-muted small">
                <i class="fa-solid fa-lock"></i> El tipo no se puede cambiar al editar.
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label">Nombre del Material</label>
                <input type="text" class="form-control" th:field="*{nombre}" required placeholder="Ej: Botellas PET">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Categoría</label>
                <select class="form-select" th:field="*{categoria}" required>
                    <option value="">-- Seleccione --</option>
                    <option th:each="c : ${listaCategorias}" th:value="${c.id}" th:text="${c.nombre}"></option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Unidad de Medida</label>
                <select class="form-select" th:field="*{unidad}" id="selectUnidad" onchange="actualizarSufijoUnidad()">
                    <option value="KG">Kilogramos (KG)</option>
                    <option value="UNIDAD">Unidades (PZA)</option>
                    <option value="TON">Toneladas (TON)</option>
                </select>
            </div>

            <div class="col-md-12 mb-3 form-check form-switch ps-5" th:if="${material.id != null}">
                <input class="form-check-input" type="checkbox" role="switch" id="switchActivo" th:field="*{activo}">
                <label class="form-check-label" for="switchActivo">Habilitar Material (Activo)</label>
            </div>
        </div>

        <hr class="text-muted">

        <div class="row align-items-end">

            <div class="col-md-12 mb-3" id="divPrecio">
                <label class="form-label fw-bold" id="lblPrecio">Precio</label>
                <div class="input-group">
                    <span class="input-group-text" id="spanMoneda">S/</span>
                    <input type="number" step="0.01" class="form-control" th:field="*{precio}" id="inputPrecio"
                        placeholder="0.00">
                    <span class="input-group-text" id="sufijoUnidadPrecio">/u</span>
                </div>
                <small class="text-muted" style="font-size: 0.75rem;" id="msgAyudaPrecio">Monto.</small>
            </div>

            <div class="col-md-6 mb-3" id="divFactor" style="display:none;">
                <label class="form-label text-info-emphasis fw-bold">Factor Conversion*</label>
                <div class="input-group">
                    <span class="input-group-text bg-info-subtle text-info-emphasis fw-bold">x</span>
                    <input type="number" step="0.1" class="form-control border-info" th:field="*{factorConversion}"
                        placeholder="1.0">
                </div>
            </div>

            <div class="col-12" id="msgAyudaFactor" style="display:none;">
                <small class="text-muted fst-italic" style="font-size: 0.75rem;">*Indica que cantidad de residuo se
                    requieren para crear 1 unidad de este producto.</small>
            </div>
        </div>

    </div>

    <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" style="background-color: #6f42c1; border-color: #6f42c1;">
            <i class="fa-solid fa-save"></i> Guardar
        </button>
    </div>

    <script>
        function cambiarFormulario() {
            let tipo = document.querySelector('input[name="tipo"]:checked').value;

            let divPrecio = document.getElementById("divPrecio");
            let lblPrecio = document.getElementById("lblPrecio");
            let inputPrecio = document.getElementById("inputPrecio");
            let spanMoneda = document.getElementById("spanMoneda");
            let msgAyuda = document.getElementById("msgAyudaPrecio");

            let divFactor = document.getElementById("divFactor");
            let msgAyudaFactor = document.getElementById("msgAyudaFactor");

            // Reset classes
            lblPrecio.className = "form-label fw-bold";
            inputPrecio.className = "form-control";
            spanMoneda.className = "input-group-text";

            if (tipo === "RESIDUO") {
                // Configuración Compra (Residuo) -> Color warning
                divPrecio.className = "col-md-12 mb-3";
                lblPrecio.textContent = "Precio de Compra (Costo)";
                lblPrecio.classList.add("text-warning-emphasis");

                inputPrecio.classList.add("border-warning");
                spanMoneda.classList.add("bg-warning-subtle", "text-warning-emphasis");

                msgAyuda.textContent = "Monto que se paga al reciclador por este material.";
                msgAyuda.style.display = "block";

                divFactor.style.display = "none";
                msgAyudaFactor.style.display = "none";
            } else {
                // Configuración Venta (Producto) -> Color success
                divPrecio.className = "col-md-6 mb-3";
                lblPrecio.textContent = "Precio Venta";
                lblPrecio.classList.add("text-success-emphasis");

                inputPrecio.classList.add("border-success");
                spanMoneda.classList.add("bg-success-subtle", "text-success-emphasis");

                msgAyuda.style.display = "none";

                divFactor.style.display = "block";
                msgAyudaFactor.style.display = "block";
            }
        }

        function actualizarSufijoUnidad() {
            let unidad = document.getElementById("selectUnidad").value;
            let texto = "/ " + unidad.toLowerCase();
            if (unidad === 'UNIDAD') texto = "/ u";
            if (unidad === 'KG') texto = "/ kg";
            if (unidad === 'TON') texto = "/ ton";

            // Actualizamos el único sufijo que existe ahora
            let sufijo = document.getElementById("sufijoUnidadPrecio");
            if (sufijo) sufijo.textContent = texto;
        }

        // Initialize
        cambiarFormulario();
        actualizarSufijoUnidad();
    </script>

</form>